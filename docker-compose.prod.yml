# ============================================================================
# DOCKER-COMPOSE.PROD.YML - PRODUCTION (Sans PostgreSQL local, utilise Neon)
# ============================================================================
#
# USAGE:
#   docker compose -f docker-compose.prod.yml up -d
#   docker compose -f docker-compose.prod.yml down
#   docker compose -f docker-compose.prod.yml logs -f
#
# PRÉREQUIS:
#   - Configurer DATABASE_URL dans .env vers Neon
#
# ============================================================================

services:
  # =========================================================================
  # MIGRATIONS (s'exécute automatiquement au démarrage)
  # =========================================================================
  migrations:
    build:
      context: ./database
      dockerfile: Dockerfile
    container_name: ecotrack-migrations
    environment:
      DATABASE_URL: ${DATABASE_URL}
      RUN_SEEDS: ${RUN_SEEDS:-false}
    networks:
      - ecotrack
    restart: "no"

  # =========================================================================
  # API GATEWAY (port 3000)
  # =========================================================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: ecotrack-api-gateway
    environment:
      GATEWAY_PORT: 3000
      USERS_SERVICE_URL: http://service-users:3010
      GATEWAY_RATE_WINDOW_MS: ${GATEWAY_RATE_WINDOW_MS:-60000}
      GATEWAY_RATE_MAX: ${GATEWAY_RATE_MAX:-100}
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      service-users:
        condition: service_healthy
    networks:
      - ecotrack
    restart: always
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # =========================================================================
  # SERVICE-USERS (port 3010)
  # =========================================================================
  service-users:
    build:
      context: ./services/service-users
      dockerfile: Dockerfile
    container_name: ecotrack-service-users
    environment:
      APP_PORT: 3010
      # Connexion à Neon (cloud)
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      NODE_ENV: production
    ports:
      - "3010:3010"
    depends_on:
      migrations:
        condition: service_completed_successfully
    networks:
      - ecotrack
    restart: always
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

# ============================================================================
# RÉSEAU
# ============================================================================
networks:
  ecotrack:
    driver: bridge
