# ============================================================================
# DOCKER-COMPOSE.YML - ECOTRACK (Microservices + PostgreSQL + PgAdmin)
# ============================================================================
#
# COMMANDES PRINCIPALES:
#   docker compose up -d                    # Démarrer tous les services
#   docker compose up -d postgres pgadmin   # Démarrer uniquement DB + PgAdmin
#   docker compose down                     # Arrêter
#   docker compose down -v                  # Arrêter + supprimer volumes (RESET)
#   docker compose logs -f postgres         # Logs PostgreSQL
#
# ACCÈS:
#   - API Gateway:    http://localhost:3000
#   - Service Users:  http://localhost:3010
#   - PgAdmin:        http://localhost:5050 (admin@ecotrack.dev / admin)
#   - PostgreSQL:     localhost:5432 (ecotrack_user / ecotrack_password)
#
# ============================================================================

services:
  # =========================================================================
  # POSTGRESQL 16 + POSTGIS (Base de données locale)
  # =========================================================================
  postgres:
    image: postgis/postgis:16-3.4-alpine
    container_name: ecotrack-postgres
    environment:
      POSTGRES_USER: ${DB_USER:-ecotrack_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-ecotrack_password}
      POSTGRES_DB: ${DB_NAME:-ecotrack}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Script d'initialisation (extensions, etc.)
      - ./database/init:/docker-entrypoint-initdb.d:ro
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ecotrack_user} -d ${DB_NAME:-ecotrack}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # PGADMIN 4 (Interface graphique pour PostgreSQL)
  # =========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ecotrack-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ecotrack.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./database/pgadmin/servers.json:/pgadmin4/servers.json:ro
    networks:
      - ecotrack
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # MIGRATIONS (s'exécute automatiquement au démarrage)
  # =========================================================================
  migrations:
    build:
      context: ./database
      dockerfile: Dockerfile
    container_name: ecotrack-migrations
    environment:
      DATABASE_URL: postgresql://${DB_USER:-ecotrack_user}:${DB_PASSWORD:-ecotrack_password}@postgres:5432/${DB_NAME:-ecotrack}
      RUN_SEEDS: ${RUN_SEEDS:-true}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ecotrack
    # Ce container s'arrête après avoir terminé les migrations
    restart: "no"

  # =========================================================================
  # API GATEWAY (port 3000)
  # =========================================================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: ecotrack-api-gateway
    environment:
      GATEWAY_PORT: 3000
      USERS_PORT: 3010
      USERS_SERVICE_URL: http://service-users:3010
      CONTAINERS_SERVICE_URL: http://service-containers:3011
      ROUTES_SERVICE_URL: http://service-routes:3012
      IOT_SERVICE_URL: http://service-iot:3013
      GAMIFICATIONS_SERVICE_URL: http://service-gamifications:3014
      ANALYTICS_SERVICE_URL: http://service-analytics:3015
      GATEWAY_RATE_WINDOW_MS: ${GATEWAY_RATE_WINDOW_MS:-60000}
      GATEWAY_RATE_MAX: ${GATEWAY_RATE_MAX:-100}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3000:3000"
    depends_on:
      service-users:
        condition: service_healthy
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # SERVICE-USERS (port 3010)
  # =========================================================================
  service-users:
    build:
      context: ./services/service-users
      dockerfile: Dockerfile
    container_name: ecotrack-service-users
    environment:
      APP_PORT: 3010
      # Connexion à PostgreSQL local
      DATABASE_URL: postgresql://${DB_USER:-ecotrack_user}:${DB_PASSWORD:-ecotrack_password}@postgres:5432/${DB_NAME:-ecotrack}
      JWT_SECRET: ${JWT_SECRET:-change_me_in_production_access_secret}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change_me_in_production_refresh_secret}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3010:3010"
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # SERVICE-CONTAINERS (port 3011) - Gestion des conteneurs et zones
  # =========================================================================
  service-containers:
    build:
      context: ./services/service-containers
      dockerfile: Dockerfile
    container_name: ecotrack-service-containers
    environment:
      APP_PORT: 3011
      # Variables PostgreSQL
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${DB_USER:-ecotrack_user}
      PGPASSWORD: ${DB_PASSWORD:-ecotrack_password}
      PGDATABASE: ${DB_NAME:-ecotrack}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3011:3011"
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # SERVICES PLACEHOLDER (à implémenter)
  # =========================================================================

  service-routes:
    profiles: [placeholder]
    build:
      context: ./services/service-routes
      dockerfile: Dockerfile
    container_name: ecotrack-service-routes
    environment:
      APP_PORT: 3012
      DATABASE_URL: postgresql://${DB_USER:-ecotrack_user}:${DB_PASSWORD:-ecotrack_password}@postgres:5432/${DB_NAME:-ecotrack}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3012:3012"
    networks:
      - ecotrack
    restart: unless-stopped

  service-iot:
    profiles: [placeholder]
    build:
      context: ./services/service-iot
      dockerfile: Dockerfile
    container_name: ecotrack-service-iot
    environment:
      APP_PORT: 3013
      DATABASE_URL: postgresql://${DB_USER:-ecotrack_user}:${DB_PASSWORD:-ecotrack_password}@postgres:5432/${DB_NAME:-ecotrack}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3013:3013"
    networks:
      - ecotrack
    restart: unless-stopped

  service-gamifications:
    build:
      context: ./services/service-gamifications
      dockerfile: Dockerfile
    container_name: ecotrack-service-gamifications
    environment:
      PORT: 3014
      DATABASE_URL: postgresql://${DB_USER:-ecotrack_user}:${DB_PASSWORD:-ecotrack_password}@postgres:5432/${DB_NAME:-ecotrack}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3014:3014"
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  service-analytics:
    profiles: [placeholder]
    build:
      context: ./services/service-analytics
      dockerfile: Dockerfile
    container_name: ecotrack-service-analytics
    environment:
      APP_PORT: 3015
      DATABASE_URL: postgresql://${DB_USER:-ecotrack_user}:${DB_PASSWORD:-ecotrack_password}@postgres:5432/${DB_NAME:-ecotrack}
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "3015:3015"
    networks:
      - ecotrack
    restart: unless-stopped

# ============================================================================
# VOLUMES (Persistance des données)
# ============================================================================
volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local

# ============================================================================
# RÉSEAU
# ============================================================================
networks:
  ecotrack:
    driver: bridge
